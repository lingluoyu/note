### 定时任务框架

#### 单机

- `java.util.Timer`：可以通过创建 [`java.util.TimerTask`](https://github.com/frohoff/jdk8u-jdk/blob/master/src/share/classes/sun/misc/TimerTask.java) 调度任务，在同一个线程中**串行**执行，相互影响。也就是说，对于同一个 Timer 里的多个 TimerTask 任务，如果一个 TimerTask 任务在执行中，其它 TimerTask 即使到达执行的时间，也只能排队等待。因为 Timer 是串行的，同时存在 [坑坑](https://blog.csdn.net/qincidong/article/details/82526458) ，所以后来 JDK 又推出了 ScheduledExecutorService ，Timer 也基本不再使用。
- [`java.util.concurrent.ScheduledExecutorService`](https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/java/util/concurrent/ScheduledExecutorService.java) ：在 JDK 1.5 新增，基于线程池设计的定时任务类，每个调度任务都会被分配到线程池中**并发**执行，互不影响。这样，ScheduledExecutorService 就解决了 Timer 串行的问题。缺点是仅支持按照指定频率，不**直接**支持指定时间的定时调度。它们是进程级别，而我们为了实现定时任务的高可用，需要部署多个进程。此时需要等多考虑，多个进程下，同一个任务在相同时刻，不能重复执行。
- spring定时框架：配置简单功能较多，如果系统使用单机的话可以优先考虑spring定时器

#### 分布

- Quartz：Java事实上的定时任务标准。但Quartz关注点在于定时任务而非数据，并无一套根据数据处理而定制化的流程。虽然Quartz可以基于数据库实现作业的高可用，但缺少分布式并行调度的功能。
- TBSchedule：阿里早期开源的分布式任务调度系统。代码略陈旧，使用timer而非线程池执行任务调度。众所周知，timer在处理异常状况时是有缺陷的。而且TBSchedule作业类型较为单一，只能是获取/处理数据一种模式，文档缺失比较严重。
- elastic-job：当当开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片，并且可以支持云开发
- Saturn：是唯品会自主研发的分布式的定时任务的调度平台，基于当当的elastic-job 版本1开发，并且可以很好的部署到docker容器上。
- xxl-job: 是大众点评员工徐雪里于2015年发布的分布式任务调度平台，是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。

#### Spring Task 和 Quartz

##### task：

- 默认单线程同步执行
- 支持注解（个人建议：不要把表达式通过注解的方式实现：不利于维护）
- 多个任务时，一个任务执行完毕以后才能执行下一个任务（如果当前任务执行时间过长，那么下一个任务可能无法及时运行，即会有阻塞现象发生），如果希望并发运行，需要配置线程池
- 对异常的处理：一旦某个任务在执行过程中抛出异常，则整个定时器生命周期就结束，以后永远不会再执行定时器任务。
- 任务类的对象：SpringTask则每次使用同一个任务类对象。

##### quartz：

- 默认多线程异步执行
- 能被集群实例化，支持分布式部署
- 使用JobStoreCMT（JDBCJobStore的子类），Quartz 能参与JTA事务；Quartz 能管理JTA事务(开始和提交)在执行任务之间，这样，任务做的事就可以发生在JTA事务里。
- 多个任务时，任务之间没有直接影响，多任务执行的快慢取决于CPU的性能
- 需要手动在xml或配置类中设置jobs（先配置job，之后为job设置特定trigger，最后将trigger在调度器中注册即可）
- 需要引入quartz的jar包
- 对异常的处理：Quartz的某次执行任务过程中抛出异常，不影响下一次任务的执行，当下一次执行时间到来时，定时器会再次执行任务。
- 任务类的对象：Quartz每次执行都创建一个新的任务类对象。



| 特性     | quartz                                                 | elastic-job-lite                                             | xxl-job                                                      |
| -------- | ------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 依赖     | MySQL、jdk                                             | jdk、zookeeper                                               | mysql、jdk                                                   |
| 高可用   | 多节点部署，通过竞争数据库锁来保证只有一个节点执行任务 | 通过zookeeper的注册与发现，可以动态的添加服务器              | 基于竞争数据库锁保证只有一个节点执行任务，支持水平扩容。可以手动增加定时任务，启动和暂停任务，有监控 |
| 任务分片 | ×                                                      | √                                                            | √                                                            |
| 管理界面 | ×                                                      | √                                                            | √                                                            |
| 难易程度 | 简单                                                   | 简单                                                         | 简单                                                         |
| 高级功能 | -                                                      | 弹性扩容，多种作业模式，失效转移，运行状态收集，多线程处理数据，幂等性，容错处理，spring命名空间支持 | 弹性扩容，分片广播，故障转移，Rolling实时日志，GLUE（支持在线编辑代码，免发布）,任务进度监控，任务依赖，数据加密，邮件报警，运行报表，国际化 |


